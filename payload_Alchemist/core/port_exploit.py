# core/port_exploit.py
import subprocess

def exploit_services(nmap_results):
    print("[*] Attempting exploits on open ports...")
    exploits_run = []

    for entry in nmap_results:
        ip = entry.get("ip")
        ports = entry.get("open_ports", [])

        for port in ports:
            if port == 21:
                result = attempt_ftp_anonymous(ip)
                if result: exploits_run.append(result)
            elif port == 445:
                result = check_smb_null_session(ip)
                if result: exploits_run.append(result)
            elif port == 3306:
                result = check_mysql_unauth(ip)
                if result: exploits_run.append(result)

    print("[*] Exploitation Summary:")
    for r in exploits_run:
        print(f"    [+] {r}")

def attempt_ftp_anonymous(ip):
    try:
        print(f"[*] Checking anonymous FTP on {ip}")
        result = subprocess.run(
            ["nmap", "-p", "21", "--script", "ftp-anon", ip],
            capture_output=True,
            text=True
        )
        if "Anonymous FTP login allowed" in result.stdout:
            return f"Anonymous FTP login allowed on {ip}:21"
    except Exception as e:
        return f"FTP check failed on {ip}: {e}"
    return None

def check_smb_null_session(ip):
    try:
        print(f"[*] Checking SMB null session on {ip}")
        result = subprocess.run(
            ["nmap", "-p", "445", "--script", "smb-enum-shares", ip],
            capture_output=True,
            text=True
        )
        if "anonymous" in result.stdout.lower():
            return f"SMB null session allowed on {ip}:445"
    except Exception as e:
        return f"SMB check failed on {ip}: {e}"
    return None

def check_mysql_unauth(ip):
    try:
        print(f"[*] Checking unauthenticated MySQL on {ip}")
        result = subprocess.run(
            ["nmap", "-p", "3306", "--script", "mysql-empty-password", ip],
            capture_output=True,
            text=True
        )
        if "empty password" in result.stdout.lower():
            return f"MySQL unauthenticated access on {ip}:3306"
    except Exception as e:
        return f"MySQL check failed on {ip}: {e}"
    return None
